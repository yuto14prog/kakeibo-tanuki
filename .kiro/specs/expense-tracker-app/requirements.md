# 要件書

## 概要

複数のクレジットカードの支出を手動で登録し、家計の出費を効率的に管理するためのWebアプリケーション。ユーザーが複数のクレジットカードを登録し、各カードの支出を記録して、カテゴリ別・カード別に分類し、月次・年次の支出傾向を把握できるシンプルで使いやすい家計簿アプリを提供する。

## 要件

### 要件1：クレジットカード管理

**ユーザーストーリー:** 家計管理をしたいユーザーとして、複数のクレジットカードを登録・管理したい。そうすることで、各カードの支出を個別に追跡できるようになる。

#### 受け入れ基準

1. ユーザーがカード管理画面にアクセスしたとき、システムは登録済みカードの一覧を表示する
2. ユーザーが新しいカードを追加するとき、システムはカード名、色またはアイコンの入力フォームを表示する
3. ユーザーがカード情報を保存したとき、システムはカードデータを保存し、一覧に追加する
4. カード名が未入力の場合、システムはエラーメッセージを表示する
5. ユーザーがカードを削除しようとしたとき、そのカードに関連する支出がある場合、システムは警告メッセージを表示する
6. ユーザーがカード削除を確認したとき、システムはカードと関連する支出データを削除する

### 要件2：支出の登録

**ユーザーストーリー:** 家計管理をしたいユーザーとして、特定のクレジットカードの支出を手動で登録したい。そうすることで、カード別にすべての出費を記録して管理できるようになる。

#### 受け入れ基準

1. ユーザーが支出登録画面にアクセスしたとき、システムは支出情報入力フォームを表示する
2. ユーザーが金額、日付、クレジットカード、カテゴリ、説明を入力して保存ボタンを押したとき、システムは支出データを保存する
3. 金額が未入力または0以下の場合、システムはエラーメッセージを表示する
4. クレジットカードが未選択の場合、システムはエラーメッセージを表示する
5. 日付が未来の日付の場合、システムは警告メッセージを表示する
6. 支出が正常に保存されたとき、システムは成功メッセージを表示し、フォームをクリアする

### 要件3：支出の一覧表示

**ユーザーストーリー:** 家計管理をしたいユーザーとして、登録した支出の一覧を確認したい。そうすることで、過去の支出履歴をカード別・カテゴリ別に把握できる。

#### 受け入れ基準

1. ユーザーが支出一覧画面にアクセスしたとき、システムは登録済みの支出を日付順（新しい順）で表示する
2. 各支出項目について、システムは日付、金額、クレジットカード名、カテゴリ、説明を表示する
3. ユーザーが期間フィルターを設定したとき、システムは指定期間内の支出のみを表示する
4. ユーザーがカテゴリフィルターを設定したとき、システムは指定カテゴリの支出のみを表示する
5. ユーザーがクレジットカードフィルターを設定したとき、システムは指定カードの支出のみを表示する
6. ユーザーが複数のフィルターを組み合わせたとき、システムはすべての条件を満たす支出のみを表示する

### 要件4：カテゴリ管理

**ユーザーストーリー:** 家計管理をしたいユーザーとして、支出をカテゴリ別に分類したい。そうすることで、どの分野にどれくらい支出しているかを把握できる。また、他の人と折半する支出については共通フラグを設定して別途管理したい。

#### 受け入れ基準

1. システムは基本的なカテゴリ（食費、交通費、娯楽費、光熱費、その他）を提供する
2. ユーザーがカスタムカテゴリを追加したとき、システムは新しいカテゴリを保存し、選択肢に追加する
3. ユーザーがカテゴリに共通フラグを設定したとき、システムはそのカテゴリを折半対象として記録する
4. ユーザーがカテゴリを編集したとき、システムは既存の支出データのカテゴリも更新する
5. ユーザーがカテゴリを削除しようとしたとき、そのカテゴリに関連する支出がある場合、システムは警告メッセージを表示する
6. システムは共通フラグが設定されたカテゴリに「折半」または「共通」ラベルを表示する

### 要件5：支出の編集・削除

**ユーザーストーリー:** 家計管理をしたいユーザーとして、間違って登録した支出を修正または削除したい。そうすることで、正確な家計データを維持できる。

#### 受け入れ基準

1. ユーザーが支出項目の編集ボタンをクリックしたとき、システムは編集フォームを表示し、既存データを入力欄に表示する
2. ユーザーが編集内容を保存したとき、システムは変更を保存し、一覧画面に戻る
3. ユーザーが支出項目の削除ボタンをクリックしたとき、システムは確認ダイアログを表示する
4. ユーザーが削除を確認したとき、システムは支出データを削除し、一覧から除外する

### 要件6：月次・年次レポート (完了)

**ユーザーストーリー:** 家計管理をしたいユーザーとして、月別や年別の支出統計をカード別・カテゴリ別に確認したい。特に共通支出については折半額を自動計算して表示したい。そうすることで、支出傾向を把握し、家計改善に役立てることができる。

#### 受け入れ基準 (全て実装済み)

1. ✅ ユーザーがレポート画面にアクセスしたとき、システムは当月の支出合計とカテゴリ別・カード別内訳を表示する
2. ✅ ユーザーが月を選択したとき、システムは指定月の支出統計を表示する（null安全性チェック含む）
3. ✅ システムは共通フラグが設定されたカテゴリの支出を集計し、折半額（総額の50%）を計算して表示する
4. ✅ ユーザーが年次レポートを選択したとき、システムは月別の支出推移グラフを表示する
5. ✅ システムはChart.jsを使用したカテゴリ別支出の円グラフと線グラフを表示する
6. ✅ システムはクレジットカード別支出の円グラフを表示する
7. ✅ ユーザーが特定のカードを選択したとき、システムはそのカードのカテゴリ別支出内訳を表示する
8. ✅ システムは共通支出の詳細内訳とカテゴリ別の折半額を専用セクションで表示する

### 要件7：データの永続化 (完了)

**ユーザーストーリー:** 家計管理をしたいユーザーとして、登録したデータが失われないようにしたい。そうすることで、長期的な家計管理ができる。

#### 受け入れ基準 (全て実装済み)

1. ✅ ユーザーが支出を登録したとき、システムはPostgreSQLデータベースにデータを保存する
2. ✅ ユーザーがクレジットカードを登録したとき、システムはカード情報をデータベースに保存する
3. ✅ ユーザーがカテゴリを追加・編集したとき、システムはカテゴリ情報をデータベースに保存する
4. ✅ ユーザーがアプリを再起動したとき、システムはデータベースから保存されたデータを復元して表示する
5. ✅ データベース接続に失敗した場合、システムはエラーメッセージを表示し、ユーザーに再試行を促す
6. ✅ データ保存に失敗した場合、システムはトランザクションをロールバックし、エラーメッセージを表示する