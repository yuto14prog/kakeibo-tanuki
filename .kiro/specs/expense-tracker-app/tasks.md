# 実装計画

## 実装状況（2025-07-19更新）

### ✅ 完了済み
- **1. プロジェクト構造とDockerコンテナ設定** (完了)
- **2. データベースコンテナとマイグレーション設定** (完了)
- **3. データモデルとバリデーションの実装** (完了)
- **4. データベース層の実装** (完了)
- **5. API エンドポイントの実装** (完了)
  - カード管理API (CRUD)
  - カテゴリ管理API (CRUD)
  - 支出管理API (CRUD + フィルタリング)
  - レポート機能API (月次・年次)
- **8. フロントエンド基盤の実装** (完了)
  - React + TypeScript + Vite セットアップ
  - ルーティング設定
  - API通信レイヤー
  - 基本ダッシュボード
- **9. カード管理UIの実装** (完了)
  - カード一覧・作成・編集・削除機能
  - カラーピッカー機能
- **10. 支出管理UIの実装** (完了)
  - 支出登録・編集・削除フォーム
  - 支出一覧・フィルタリング機能
  - カテゴリ色表示機能
- **11.1, 11.2 レポート画面UI実装** (完了)
  - 月次・年次レポート表示
  - Chart.js グラフ表示（円グラフ、線グラフ）
  - 共通支出専用セクションと折半額計算
- **11.3 カテゴリ管理UIの実装** (完了)
  - カテゴリ一覧・作成・編集・削除機能
  - カテゴリカラーピッカー機能
  - 共通フラグ機能（折半対象設定）

### 🎨 UI/UX 機能
- **ダークテーマ対応** (完了)
  - テーマ切り替えボタン
  - LocalStorage永続化
  - 全コンポーネントのダークモード対応
  - コントラスト最適化
- **レスポンシブデザイン** (完了)
  - モバイルハンバーガーメニュー
  - タブレット・スマホ対応レイアウト
- **アクセシビリティ** (完了)
  - アクセントカラー: #8142e7
  - 視覚的フィードバック
  - キーボードナビゲーション

### 🔧 技術的な変更・修正
- **Go バージョン**: 1.23+ (Docker: golang:1.23-alpine)
- **フロントエンドコンテナ追加**: docker-compose.dev.yml
- **APIリクエスト形式修正**: 日付・UUID文字列パース対応
- **カテゴリモデル修正**: Color フィールド必須対応
- **エラーハンドリング強化**: バリデーションエラー詳細表示
- **Docker環境修正**: PostgreSQL timezone設定をUTCに変更
- **レポート画面の安定性向上**: null安全性チェック追加とフィルター選択時のクラッシュ修正
- **テスト環境整備**: testify, sqlmock, SQLiteドライバー追加
- **プロジェクト構造改善**: テストファイルの分離と整理

### ✅ 共通フラグ機能 (2025-07-19追加・完了)
- **DBスキーマ更新**: categoriesテーブルにis_sharedカラム追加
- **バックエンドモデル拡張**: Category、MonthlyReport、SharedExpensesSummary
- **API機能強化**: 共通支出集計と折半額計算
- **フロントエンド型定義**: 共通フラグ対応型追加
- **UI機能追加**:
  - カテゴリ管理に共通フラグチェックボックス
  - 全画面に「共通」バッジ表示
  - 月次レポートに共通支出専用セクション
  - ダークテーマ対応強化

### ✅ テスト実装 (2025-07-26完了)
- **Goバックエンド単体・統合テスト** (完了)
  - モデル層バリデーションテスト: Card, Category, Expense
  - リポジトリ層CRUD操作テスト、外部キー制約テスト
  - API統合テスト: CRUD操作、バリデーション、エラーハンドリング
  - testifyライブラリ使用、インメモリSQLite、日本語テストデータ対応
  - 合計81テストケース、全テストPASS達成
  - テストファイル構造整理: `backend/tests/{unit,integration}`
- **フロントエンド包括的単体テスト** (完了)
  - React コンポーネントテスト: LoadingSpinner, Modal, Header, ConfirmDialog
  - ページコンポーネントテスト: CardManagement (CRUD操作テスト)
  - コンテキストテスト: ThemeContext (ダークモード切替テスト)
  - API サービス層テスト: 全API (cardApi, categoryApi, expenseApi, reportApi, healthApi)
  - カスタムフックテスト: useApi, useLocalStorage
  - ユーティリティ関数テスト: format, validation
  - Jest + React Testing Library + userEvent使用
  - 合計148テストケース、全テストPASS達成
  - import.meta.env構文エラー対応、UIアイコンボタン対応済み
  - テスト環境整備: setupTests.ts, jest.config.js, Chart.jsモック対応

### ✅ E2Eテスト実装 (2025-07-26完了)
- **フロントエンドE2Eテスト** (完了)
  - Playwright テストフレームワーク設定: playwright.config.ts, e2e/ディレクトリ構成
  - 基本起動確認テスト: アプリケーション初期表示とナビゲーション
  - 支出管理フローテスト: 登録→編集→削除の完全フロー、フィルタリング、バリデーション
  - カード管理機能テスト: CRUD操作、カラーピッカー、バリデーション、関連データ警告
  - カテゴリ管理機能テスト: CRUD操作、共通フラグ、バリデーション、デフォルトカテゴリ
  - レポート機能テスト: 月次・年次表示、グラフ描画、null安全性、パフォーマンス
  - ダークモードテスト: テーマ切り替え、設定永続化、アニメーション、アクセシビリティ
  - レスポンシブデザインテスト: モバイル・タブレット・デスクトップ対応、ビューポート切り替え
  - テストユーティリティ: test-utils.ts共通関数、テストデータ、ヘルパー関数
  - 合計8テストスイート、包括的なユーザーフローカバレッジ達成

### 🚧 実装予定

---

## 詳細実装計画

- [x] 1. プロジェクト構造とDockerコンテナ設定
  - Go モジュールの初期化とディレクトリ構造の作成
  - Docker Compose設定（フロントエンド、バックエンド、データベース）
  - 各コンテナ用のDockerfileの作成
  - 環境変数設定とコンテナ間通信の設定
  - _要件: 7.1, 7.5_

- [x] 2. データベースコンテナとマイグレーション設定
  - PostgreSQLコンテナの設定
  - データベースマイグレーションスクリプトの作成
  - 初期データ（デフォルトカテゴリ）のシードスクリプト
  - コンテナ起動時の自動マイグレーション設定
  - _要件: 4.1, 7.1_

- [x] 3. データモデルとバリデーションの実装
- [x] 3.1 コアデータモデルインターフェースと型の作成
  - Card、Category、Expense構造体の定義
  - バリデーション関数の実装
  - データ整合性チェック機能の実装
  - _要件: 1.3, 4.2, 7.1_

- [x] 3.2 Cardモデルとバリデーションの実装
  - Card構造体とGORMタグの実装
  - カード名バリデーションの単体テスト作成
  - カード作成・更新のバリデーション機能
  - _要件: 1.4_

- [x] 3.3 Categoryモデルとデフォルトカテゴリの実装
  - Category構造体の実装
  - デフォルトカテゴリ（食費、交通費等）のシードデータ作成
  - カテゴリ名の一意性制約とバリデーション
  - _要件: 4.1_

- [x] 3.4 Expenseモデルと関連性の実装
  - Expense構造体と外部キー関係の実装
  - 金額・日付バリデーションの実装
  - カードとカテゴリとの関連付け機能
  - _要件: 2.3, 2.4, 2.5_

- [x] 4. データベース層の実装
- [x] 4.1 データベース接続ユーティリティの実装
  - PostgreSQL接続管理コードの作成
  - データベース操作のエラーハンドリングユーティリティ
  - 接続プールの設定
  - データベース接続失敗時のリトライ機能
  - _要件: 7.5, 7.6_

- [x] 4.2 リポジトリパターンによるデータアクセスの実装
  - ベースリポジトリインターフェースの作成
  - CRUD操作を含む具象リポジトリの実装
  - トランザクション管理機能の実装
  - リポジトリ操作の単体テスト作成
  - _要件: 7.1, 7.2, 7.3, 7.6_

- [x] 4. カード管理APIの実装
- [x] 4.1 カードCRUD APIエンドポイントの実装
  - GET /api/cards（一覧取得）の実装
  - POST /api/cards（作成）の実装
  - PUT /api/cards/:id（更新）の実装
  - DELETE /api/cards/:id（削除）の実装
  - _要件: 1.1, 1.2, 1.3_

- [x] 4.2 カード削除時の関連データチェック機能
  - カード削除前の支出データ存在チェック
  - 警告メッセージ機能の実装
  - カスケード削除の実装とテスト
  - _要件: 1.5, 1.6_

- [x] 5. カテゴリ管理APIの実装
- [x] 5.1 カテゴリCRUD APIエンドポイントの実装
  - GET /api/categories（一覧取得）の実装
  - POST /api/categories（作成）の実装
  - PUT /api/categories/:id（更新）の実装
  - DELETE /api/categories/:id（削除）の実装
  - _要件: 4.2, 4.3_

- [x] 5.2 カテゴリ削除時の制約チェック機能
  - カテゴリ削除前の支出データ存在チェック
  - 関連データがある場合の警告機能
  - 制約違反時のエラーハンドリング
  - _要件: 4.4_

- [x] 6. 支出管理APIの実装
- [x] 6.1 支出CRUD APIエンドポイントの実装
  - GET /api/expenses（一覧取得）の実装
  - POST /api/expenses（作成）の実装
  - PUT /api/expenses/:id（更新）の実装
  - DELETE /api/expenses/:id（削除）の実装
  - _要件: 2.1, 2.2, 5.1, 5.2, 5.3, 5.4_

- [x] 6.2 支出フィルタリング機能の実装
  - 期間フィルター（日付範囲）の実装
  - カテゴリフィルターの実装
  - クレジットカードフィルターの実装
  - 複数フィルター組み合わせ機能の実装
  - _要件: 3.3, 3.4, 3.5, 3.6_

- [x] 6.3 支出データの並び順とページネーション
  - 日付順（新しい順）でのソート機能
  - ページネーション機能の実装
  - パフォーマンス最適化のためのインデックス活用
  - _要件: 3.1, 3.2_

- [x] 7. レポート機能APIの実装
- [x] 7.1 月次レポートAPIの実装
  - GET /api/reports/monthly エンドポイントの実装
  - 月別支出合計の計算機能
  - カテゴリ別・カード別内訳の集計機能
  - _要件: 6.1, 6.2_

- [x] 7.2 年次レポートAPIの実装
  - GET /api/reports/yearly エンドポイントの実装
  - 月別支出推移データの生成
  - 年間統計データの計算機能
  - _要件: 6.3_

- [x] 7.3 グラフデータ生成機能の実装
  - カテゴリ別支出の円グラフデータ生成
  - クレジットカード別支出の円グラフデータ生成
  - 特定カードのカテゴリ別内訳データ生成
  - _要件: 6.4, 6.5, 6.6_

- [x] 8. フロントエンド基盤の実装
- [x] 8.1 React プロジェクトセットアップとルーティング
  - Vite + React + TypeScript プロジェクトの作成
  - React Router による SPA ルーティングの設定
  - Tailwind CSS の設定とベーススタイルの作成
  - _要件: 全般的なUI要件_

- [x] 8.2 API通信とエラーハンドリングの実装
  - Axios HTTP クライアントの設定
  - API エラーハンドリングの共通機能実装
  - ローディング状態管理の実装
  - _要件: 全般的なエラーハンドリング要件_

- [x] 8.3 共通UIコンポーネントの実装
  - ナビゲーションヘッダーコンポーネントの作成
  - 成功・エラーメッセージ表示コンポーネント
  - 確認ダイアログコンポーネントの実装
  - ローディングスピナーコンポーネント
  - _要件: 全般的なUI要件_

- [x] 9. カード管理UIの実装
- [x] 9.1 カード一覧画面の実装
  - カード一覧表示コンポーネントの作成
  - カード追加ボタンとモーダルの実装
  - カード編集・削除機能のUI実装
  - カラーピッカー機能の実装
  - _要件: 1.1, 1.2_

- [x] 9.2 カード作成・編集フォームの実装
  - カード情報入力フォームの作成
  - バリデーションエラー表示機能
  - 成功・エラーメッセージの表示機能
  - 確認ダイアログとローディング状態
  - _要件: 1.3, 1.4_

- [x] 10. 支出管理UIの実装
- [x] 10.1 支出登録フォームの実装
  - 支出情報入力フォームの作成
  - カード・カテゴリ選択ドロップダウンの実装
  - フォームバリデーションとエラー表示
  - 編集モード対応
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 10.2 支出一覧画面の実装
  - 支出履歴表示コンポーネントの作成
  - フィルター機能UI（期間、カテゴリ、カード）の実装
  - 支出項目の編集・削除ボタンの実装
  - カテゴリ色表示機能の実装
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [x] 10.3 支出編集・削除機能の実装
  - 支出編集フォームの実装
  - 削除確認ダイアログの実装
  - 編集・削除後のデータ更新機能
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 11. レポート画面UIの実装
- [x] 11.1 月次レポート画面の実装
  - 月選択機能の実装
  - 支出合計とカテゴリ別・カード別内訳表示
  - Chart.js を使用したグラフ表示機能
  - _要件: 6.1, 6.2, 6.4, 6.5_

- [x] 11.2 年次レポート画面の実装
  - 年選択機能の実装
  - 月別支出推移グラフの実装
  - 特定カード選択時のカテゴリ別内訳表示
  - _要件: 6.3, 6.6_

- [x] 11.3 カテゴリ管理UIの実装
  - カテゴリ一覧表示画面の作成
  - カスタムカテゴリ追加フォームの実装
  - カテゴリ編集・削除機能のUI実装
  - カテゴリ削除時の警告ダイアログ実装
  - カテゴリカラーピッカー機能の実装
  - _要件: 4.2, 4.3, 4.4_

- [x] 12. テスト実装
- [x] 12.1 Goバックエンド単体テストの作成
  - モデル層のバリデーションテスト (完了)
  - リポジトリ層のデータアクセステスト (完了)
  - testifyライブラリとインメモリSQLite使用
  - 日本語テストデータでの境界値・制約テスト
  - _要件: 全般的な機能要件_

- [x] 12.2 バックエンド統合テストの作成
  - API エンドポイントの統合テスト作成 (完了)
  - データベース操作を含むテストの実装 (完了)
  - テストデータベースの設定とクリーンアップ (完了)
  - HTTPハンドラーのテスト (完了)
  - 81テストケース全てPASS達成 (完了)
  - _要件: 全般的な機能要件_

- [x] 12.3 フロントエンド単体テストの作成
  - React コンポーネントのテスト (完了)
  - API サービス層のテスト (完了)
  - ユーティリティ関数のテスト (完了)
  - カスタムフックのテスト (完了)
  - 148テストケース全てPASS達成 (完了)
  - _要件: 全般的なUI機能要件_

- [x] 12.4 フロントエンドE2Eテストの作成
  - Playwright を使用したE2Eテストの設定 (完了)
  - 主要ユーザーフローのテスト作成 (完了)
  - 支出登録から一覧表示までの一連のテスト (完了)
  - カード管理機能のE2Eテスト (完了)
  - カテゴリ管理機能のE2Eテスト (完了)
  - レポート機能のE2Eテスト (完了)
  - ダークモード・テーマ切り替えのE2Eテスト (完了)
  - レスポンシブデザインのE2Eテスト (完了)
  - 合計8テストスイート、包括的なE2Eテストカバレッジ (完了)
  - _要件: 全般的なユーザーフロー要件_

- [ ] 13. Docker環境での統合とデプロイメント設定
- [ ] 13.1 コンテナ間通信の設定と検証
  - フロントエンドからバックエンドAPIへの通信設定
  - バックエンドからデータベースへの接続設定
  - CORS設定とセキュリティ考慮事項の実装
  - _要件: 全般的なシステム要件_

- [ ] 13.2 本番環境用Docker設定の最適化
  - マルチステージビルドによるイメージサイズ最適化
  - 環境別設定ファイルの分離
  - ヘルスチェック機能の実装
  - ログ設定とモニタリング準備
  - _要件: 7.5, 7.6_